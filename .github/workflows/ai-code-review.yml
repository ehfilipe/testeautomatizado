name: CI - Tests and Lint

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

      # S√≥ roda revis√£o autom√°tica em PR (n√£o roda em push)
      - name: AI review PR diff and comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.warning("No pull_request found in context.");
              return;
            }

            // Se quiser ignorar PR em draft, deixa esse bloco ativo
            if (pr.draft) {
              core.info("PR is draft. Skipping review.");
              return;
            }

            // 1) Lista arquivos alterados no PR
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, per_page: 100 }
            );

            // 2) Monta um "diff" usando patches (limitando tamanho)
            const maxFiles = 15;
            const maxPatchCharsPerFile = 5000;

            const selected = files
              .filter(f => f.patch) // alguns arquivos n√£o t√™m patch (ex: binary/arquivo grande)
              .slice(0, maxFiles);

            if (selected.length === 0) {
              core.info("No text patches found to review.");
              return;
            }

            const diffText = selected.map(f => {
              const patch = f.patch.length > maxPatchCharsPerFile
                ? f.patch.slice(0, maxPatchCharsPerFile) + "\n... (patch truncado)\n"
                : f.patch;
              return `FILE: ${f.filename}\nSTATUS: ${f.status}\nPATCH:\n${patch}\n`;
            }).join("\n---\n");

            // 3) Prompt para revis√£o
            const prompt = `
            Voc√™ √© um revisor s√™nior de c√≥digo. Revise as mudan√ßas do Pull Request.
            Regras:
            - Seja objetivo.
            - Aponte: bugs prov√°veis, edge cases, melhorias de qualidade, seguran√ßa, performance e legibilidade.
            - Se poss√≠vel, sugira trechos de c√≥digo corrigidos.
            - Organize em t√≥picos.
            - Se n√£o houver problemas, diga que est√° ok.

            Aqui est√° o diff (pode estar truncado):
            ${diffText}
            `.trim();

            // 4) Chama OpenAI
            const response = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`
              },
              body: JSON.stringify({
                model: "gpt-4.1-mini",
                messages: [
                  { role: "system", content: "Voc√™ √© um revisor de c√≥digo muito criterioso e √∫til." },
                  { role: "user", content: prompt }
                ],
                temperature: 0.2
              })
            });

            if (!response.ok) {
              const errText = await response.text();
              core.setFailed(`OpenAI API error: ${response.status} ${errText}`);
              return;
            }

            const data = await response.json();
            const review = data?.choices?.[0]?.message?.content?.trim() || "Sem resposta do modelo.";

            // 5) Publica coment√°rio no PR
            const body = `## ü§ñ AI Code Review\n\n${review}\n\n---\n_Obs: revis√£o autom√°tica baseada no diff do PR (pode estar truncado)._`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body
            });

            core.info("AI review comment posted.");
